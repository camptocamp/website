sudo: required

services: docker

git:
  # we don't want travis to pull them for the lint build,
  # so we pull them manually in the tests build
  submodules: false

env:
  matrix:
    - LINT_CHECK="1"
    - TESTS="1"
  global:
    - DOCKER_COMPOSE_VERSION="1.7.1"
    - TESTS="0" LINT_CHECK="0"
    - ADDONS_DIR=${TRAVIS_BUILD_DIR}/odoo/local-src
    - SONGS_DIR=${TRAVIS_BUILD_DIR}/odoo/songs
    - COMPOSE_PROJECT_NAME=smartliberty
    - RANCHER_STACK_NAME=smartliberty-odoo-test
    - secure: "XeuISuPxR2XKndkVTqb5c3BeFKkeMyaGTYXr8aBgiKDm1GGpjeP3ynmNEpJZ25Xou1bl8iBXPIhoE6WSTe0ph8FgY0OFhIRm6N9X/0dSONj4YG6WyLMqlhLllLkG6ZNzFDcNvl6G509twAOu1iSj53v2NlbBovC3z8dLQH8tg03pKrfqutMrnFwaL9akRvJ7tcKgSIi2G8ZUdis1q5w0DT0JPYaqzd0slox3lPM4j2Cc6lsvcWRezl/btEuIP1DdWGC4pFN8Ceu2xb3Qf6+85YxB4w7aBUaU7tqnj9sMnmRbY14lFNoO7P4xkueZPDoXN1bbJdajq63h2z/GVd/+zscDLRwLXZHp9Bm/yrFWo8jEZOJwIi+Q7r4NRC8o80r2xEwwC9rJg01NQS+nC5bz6YbUH2SZR+mKdC9YwRkk/ZcAYqa8RPNKXKg63n3NV1H2VrsPnfpgoeBNA72X6Boa29P0t699Zb7tSiIay2I6RXEzDtZ9LLNB/FEyUqm0B76Zz9qh33gbyOqzj3HRIfX2LrQhsyZ4Bve0Jq//6ZyKWnwiZVh436oQ+3Fqc5u683bc5kqEUPnAYhNVC/71Zs/UVUx0zCjYHVQ4IW228BIceyaNWnUQMO5PE8Zn/SlFNSaVUg7fo9EZwztyxFYttBYhD1PK7lszo888N3amoSl8nfs="

before_install:
  - sudo apt-get update
  - sudo DEBIAN_FRONTEND=noninteractive apt-get install -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" docker-engine --yes --force-yes
  - sudo rm /usr/local/bin/docker-compose
  - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
  - chmod +x docker-compose
  - sudo mv docker-compose /usr/local/bin
  - git config --global user.name "TravisCI"
  - git config --global user.email "travis@camptocamp.com"
  - if [ "$LINT_CHECK" == "1" ] ; then pip install --user -q flake8 ; fi
  - if [ "$LINT_CHECK" == "0" ] ; then pip install --user -q gitpython ; fi

install:
  - if [ "$LINT_CHECK" == "0" ] ; then python ./travis/git_submodule_update.py ; fi
    # we always specify '-f docker-compose.yml' so 'docker-compose.override.yml'
    # is not used and so the volumes are not shared with the host
  - if [ "$LINT_CHECK" == "0" ] ; then docker-compose -f docker-compose.yml build --pull ; fi
  - if [ "$TESTS" == "1" ] ; then docker-compose -f docker-compose.yml up -d db ; fi
  - if [ "$TESTS" == "1" ] ; then docker-compose -f docker-compose.yml ps ; fi

# We run the tests and scenario in the same build, so we can push the docker image
# after that we validated it has tests and scenario passing
script:
  - if [ "$LINT_CHECK" == "1" ] ; then flake8 ${ADDONS_DIR} ${SONGS_DIR} --exclude=__init__.py ; fi
  # run tests on an empty database, which is dropped afterwards
  - if [ "$TESTS" == "1" ] ; then docker-compose -f docker-compose.yml run --rm -e ODOO_CLOUD_PLATFORM_UNSAFE=1 odoo runtests ; fi
  # run the scenario
  - if [ "$TESTS" == "1" ] ; then docker-compose -f docker-compose.yml run --rm -e ODOO_CLOUD_PLATFORM_UNSAFE=1 -e MARABUNTA_MODE=demo -e MARABUNTA_ALLOW_SERIE=True odoo odoo --stop-after-init ; fi

after_success:
  - if [ "$TESTS" == "1" ] ; then ./travis/publish.sh ; fi
